<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <title>codemill</title>
    <!-- Load required Bootstrap and BootstrapVue CSS -->
    <link type="text/css" rel="stylesheet" href="static/bootstrap.min.css" crossorigin="anonymous" />
    <link type="text/css" rel="stylesheet" href="static/bootstrap-vue.min.css" crossorigin="anonymous" />
    <!-- Load polyfills to support older browsers -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es2015%2CIntersectionObserver"></script>
    <!-- Load Vue followed by BootstrapVue -->
    <!-- VueJS development version, includes helpful console warnings -->
    <script src="static/vue.js" crossorigin="anonymous"></script>
    <script src="static/bootstrap-vue.min.js" crossorigin="anonymous"></script>
    <!-- Load the following for BootstrapVueIcons support -->
    <script src="static/bootstrap-vue-icons.min.js" crossorigin="anonymous"></script>
    <style type="text/css">
    .hidden {
        display: none;
    }

    hr {
        margin-top: 1rem;
        margin-bottom: 1rem;
        border: 0;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    .modal-dialog {
        max-width: 100%;
        margin: 0;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        border-radius: 0px;
    }

    .modal-content {
        max-width: 100%;
        margin: 0;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        border-radius: 0px;
        padding: 0px;
    }

    .tab-pane {
        padding-left: 0px;
        padding-right: 0px;
    }

    .list-group-item {
        padding: 0.50rem 0.80rem;
    }

    .documentation {
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
        font-size: 0.9em;
        line-height: 1.42;
        white-space: pre;
        word-break: normal;
        box-sizing: border-box;
        color: #006600;
    }

    .text-comment {
        color: #007bff !important;
    }

    .selected-struct-field {
        background-color: #28a745 !important;
        border-radius: 0.3em;
    }

    .custom-control-label {
        cursor: pointer;
    }

    .b-table-sticky-header,
    .table-responsive,
    [class*=table-responsive-] {
        margin-bottom: 0rem;
    }

    .comment-cell {
        padding: 0em !important;
        line-height: 1em;
    }

    .checkbox-cell {
        white-space: nowrap !important;
        float: none !important;
    }
    </style>
</head>

<body>
    <div id="codemill-app">
        <!-- Content here -->
        <b-container>
            <!-- Modal for searching packages -->
            <template>
                <b-button v-b-modal.modal-list-remote-packages>Search packages</b-button>
                <b-modal id="modal-list-remote-packages" scrollable title="Search packages" size="xl" no-close-on-backdrop>
                    <b-form v-on:submit.prevent="search">
                        <label for="search-input-field">Search</label>
                        <b-overlay :show="isBusy.search" rounded="lg" opacity="0.6">
                            <div>
                                <b-input-group class="mt-3">
                                    <b-form-input type="search" id="search-input-field" @change="updateSearchValue" class="mr-sm-6" aria-describedby="search-help-block"></b-form-input>
                                    <b-input-group-append>
                                        <b-button variant="primary" @click="search" :disabled="isBusy.search">{{isBusy.search ? "Searching..." : "Search" }}</b-button>
                                    </b-input-group-append>
                                </b-input-group>
                            </div>
                        </b-overlay>
                        <b-form-text id="search-help-block">
                            Search public Go packages.
                        </b-form-text>
                        <b-list-group v-bind:class="{ hidden: !isBusy.search }">
                            <b-list-group-item>
                                <b-skeleton animation="wave" width="85%" type="input"></b-skeleton>
                            </b-list-group-item>
                            <b-list-group-item>
                                <b-skeleton animation="wave" width="55%" type="input"></b-skeleton>
                            </b-list-group-item>
                            <b-list-group-item>
                                <b-skeleton animation="wave" width="70%" type="input"></b-skeleton>
                            </b-list-group-item>
                        </b-list-group>
                        <b-list-group v-bind:class="{ hidden: isBusy.search }">
                            <b-overlay :show="isBusy.loadCode" rounded="lg" no-wrap fixed opacity="0.7">
                                <template #overlay>
                                    <div class="text-center">
                                        <b-icon icon="cloud-download" font-scale="2" animation="fade" variant="primary"></b-icon>
                                        <p>Loading <b>{{currentPackage.path}}@{{currentPackage.version}}</b> ...</p>
                                        <p>(This may take a while...)</p>
                                    </div>
                                </template>
                            </b-overlay>
                            <span class="float-left d-inline-block" v-if="len(searchResults) == 0" variant="danger">
                                No results were found.
                            </span>
                            <cm-search-result v-for="(item, index) in searchResults" v-bind:key="item.path + index" v-bind:item="item" v-bind:index="index"></cm-search-result>
                        </b-list-group>
                    </b-form>
                    <template #modal-footer>
                        <div class="w-100">
                            <b-button variant="secondary" class="float-right" @click="$bvModal.hide('modal-list-remote-packages')">
                                Close
                            </b-button>
                        </div>
                    </template>
                </b-modal>
            </template>
        </b-container>
        <b-container>
            <template>
                <b-modal id="modal-show-code" scrollable title="Code" size="xl" lazy no-close-on-backdrop>
                    <template #modal-title>
                        Source of <b>{{currentPackage.path}}@{{currentPackage.version}}</b>
                    </template>
                    <b-form v-on:submit.prevent="">
                        <label for="element-filter-input-field">Filter</label>
                        <div>
                            <b-input-group class="mt-3">
                                <b-form-input type="search" id="element-filter-input-field" @input="updateElementFilterValue" class="mr-sm-6" aria-describedby="element-filter-help-block"></b-form-input>
                            </b-input-group>
                        </div>
                        <b-form-text id="element-filter-help-block">
                            Filter elements.
                        </b-form-text>
                    </b-form>
                    <b-tabs align="left" card>
                        <!-- This tabs content will not be mounted until the tab is shown -->
                        <!-- and will be un-mounted when hidden -->
                        <b-tab :title="'Funcs (' + len(filteredFuncs) + ')'" lazy active>
                            <b-list-group>
                                <cm-func-item v-for="item in filteredFuncs" v-bind:key="item.ID" v-bind:item="item"></cm-func-item>
                            </b-list-group>
                        </b-tab>
                        <b-tab :title="'Methods (' + len(filteredTypeMethods) + ')'" lazy>
                            <b-list-group>
                                <cm-tm-item v-for="item in filteredTypeMethods" v-bind:key="item.ID" v-bind:item="item"></cm-tm-item>
                            </b-list-group>
                        </b-tab>
                        <b-tab :title="'Interfaces (' + len(filteredInterfaceMethods) + ')'" lazy>
                            <b-list-group>
                                <cm-it-item v-for="item in filteredInterfaceMethods" v-bind:key="item.ID" v-bind:item="item"></cm-it-item>
                            </b-list-group>
                        </b-tab>
                        <b-tab :title="'Structs (' + len(filteredStructs) + ')'" lazy>
                            <b-list-group class="text-monospace float-left text-truncate">
                                <cm-struct-item v-for="item in filteredStructs" v-bind:key="item.ID" v-bind:item="item"></cm-struct-item>
                            </b-list-group>
                        </b-tab>
                    </b-tabs>
                    <template #modal-footer>
                        <div class="w-100">
                            <b-button variant="secondary" class="float-right" size="sm" @click="$bvModal.hide('modal-show-code')">
                                Close
                            </b-button>
                        </div>
                    </template>
                </b-modal>
            </template>
        </b-container>
    </div>
    <script>
    function cc(...elems) {
        return elems.join("-")
    }

    function len(elem) {
        if (elem == null) { return 0 }
        return elem.length
    }

    function marshal(obj) {
        return JSON.stringify(obj)
    }

    function revf(path, version) {
        return path + "@" + version
    }

    window.app = new Vue({
        el: '#codemill-app',
        data: {
            currentPackage: {
                source: {},
                path: "",
                version: ""
            },
            searchResults: [],
            currentSearch: "",
            currentSearchOut: "",
            isBusy: {
                search: false,
                loadCode: false
            },
            currentElementFilter: "",
        },
        created() {
            // TODO: remove.
            this.doSearch("revel");
        },
        updated() {

        },
        mounted() {

        },
        computed: {
            filteredFuncs() {
                if (!this.currentPackage.source.Funcs) {
                    return
                }
                return this.currentPackage.source.Funcs.filter(item => {
                    return this.elementFilterMatches(item.Signature) || this.docsOrCommentsMatch(item)
                });
            },
            filteredTypeMethods() {
                if (!this.currentPackage.source.TypeMethods) {
                    return
                }
                return this.currentPackage.source.TypeMethods.filter(item => {
                    return this.elementFilterMatches(item.Func.Signature) || this.docsOrCommentsMatch(item)
                });
            },
            filteredInterfaceMethods() {
                if (!this.currentPackage.source.InterfaceMethods) {
                    return
                }
                return this.currentPackage.source.InterfaceMethods.filter(item => {
                    return this.elementFilterMatches(item.Func.Signature) || this.docsOrCommentsMatch(item)
                });
            },
            filteredStructs() {
                if (!this.currentPackage.source.Structs) {
                    return
                }
                return this.currentPackage.source.Structs.filter(item => {
                    return this.elementFilterMatches(item.TypeName) || item.Fields.some(this.structFieldMatches) || this.docsOrCommentsMatch(item) || item.Fields.some(this.docsOrCommentsMatch)
                });
            },
        },
        methods: {
            cc: cc,
            len: len,
            marshal: marshal,
            revf: revf,
            makeToast(variant = null, title, body) {
                this.$bvToast.toast(
                    body, {
                        title: title,
                        variant: variant,
                        solid: true
                    })
            },
            search() {
                this.currentSearchOut = this.currentSearch.trim();
                this.doSearch(this.currentSearchOut);
            },
            updateSearchValue(val) {
                this.currentSearch = val;
            },
            updateElementFilterValue(val) {
                this.currentElementFilter = val;
            },
            elementFilterMatches(ident) {
                if (!this.currentElementFilter) {
                    return true
                }
                return ident.toLowerCase().includes(this.currentElementFilter.toLowerCase());
            },
            structFieldMatches(field) {
                return this.elementFilterMatches(field.VarName) || this.elementFilterMatches(field.TypeString)
            },
            docsOrCommentsMatch(item) {
                return (item.Docs && item.Docs.some(this.elementFilterMatches)) || (item.Comments && item.Comments.some(this.elementFilterMatches))
            },
            listVersions(searchItem) {
                console.log("getting list of versions...");
                console.log(searchItem);
                let url = '/api/versions?path=' + searchItem.path;

                fetch(url)
                    .then(response => {
                        if (response.ok) {
                            return response.json()
                        } else {
                            throw response;
                        }
                    })
                    .then(json => {
                        searchItem.versions = json.results;
                        searchItem.gotVersions = true;
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                        error.json().then((body) => {
                            this.makeToast("danger", "Error", body.error);
                        });
                    });
            },
            loadCode(path, version) {
                console.log("Loading code...selected:", this.revf(path, version));
                this.isBusy.loadCode = true;
                this.currentPackage.path = path;
                this.currentPackage.version = version;

                let url = '/api/source?path=' + path + "&v=" + version;

                fetch(url)
                    .then(response => {
                        if (response.ok) {
                            return response.json()
                        } else {
                            throw response;
                        }
                    })
                    .then(json => {
                        this.currentPackage.source = json;
                        this.isBusy.loadCode = false;
                        this.$bvModal.show('modal-show-code');

                        if (json.Module) {
                            // TODO: if the version is different from what was requested,
                            // then mark it some way.
                            this.currentPackage.version = json.Module.Version;
                        }
                    })
                    .catch((error) => {
                        this.isBusy.loadCode = false;
                        console.error('Error:', error);
                        error.json().then((body) => {
                            this.makeToast("danger", "Error", body.error);
                        });
                    });
            },
            doSearch(searchText) {
                this.isBusy.search = true;
                let url = '/api/search?q=' + searchText;

                fetch(url)
                    .then(response => {
                        if (response.ok) {
                            return response.json()
                        } else {
                            throw response;
                        }
                    })
                    .then(json => {
                        this.isBusy.search = false;

                        let gotResults = [];

                        if (json.results == null) {
                            this.searchResults = [];
                        } else {
                            json.results.forEach(function(item, itemIndex) {
                                item.versions = [];
                                item.gotVersions = false;
                                gotResults.push(item);
                            });
                            this.searchResults = gotResults;
                        }
                    })
                    .catch((error) => {
                        this.isBusy.search = false;
                        console.error('Error:', error);
                        error.json().then((body) => {
                            this.makeToast("danger", "Error", body.error);
                        });
                    });
            }
        }
    });
    </script>
    <script type="text/javascript">
    Vue.component('cm-search-result', {
        props: ['item', 'index'],
        template: "#cm-search-result-template",
        methods: {
            loadCode: function(path, version) {
                this.$root.loadCode(path, version);
            },
            listVersions: function(searchItem) {
                this.$root.listVersions(searchItem);
            },
            cc: cc,
            len: len,
            marshal: marshal,
            revf: revf
        }
    });
    </script>
    <script type="text/x-template" id="cm-search-result-template">
        <b-list-group-item :title="item.synopsis" v-bind:key="item.path + index">
          <b-row class="mr-1">
              <b-col align-self="start">
                  <span class="text-monospace float-left d-inline-block text-truncate">
                      <b-icon icon="box-seam" variant="primary"></b-icon> <b>{{item.path}}</b> as "{{item.name}}"
                  </span>
                  <span class="float-right">
                      <span title="Imported N times">{{item.import_count}} <b-icon icon="box-arrow-in-down-left" variant="warning"></b-icon></span> | <span title="Starred N times">{{item.stars}} <b-icon icon="star-fill" variant="warning"></b-icon></span>
                  </span>
              </b-col>
              <b-col align-self="end" lg="1">
                  <b-dropdown text="Select" variant="success" size="sm" @show="listVersions(item)">
                      <b-dropdown-item href="#" v-bind:class="{ hidden: item.gotVersions }" class="text-center align-items-center">
                          <b-spinner type="grow" label="Spinning" align-h="center"></b-spinner>
                      </b-dropdown-item>
                      <b-dropdown-item v-for="version in item.versions" :key="revf(item.path,version)" @click="loadCode(item.path,version)">
                          {{ version }}
                      </b-dropdown-item>
                  </b-dropdown>
              </b-col>
          </b-row>
          <b-row class="mr-1">
              <b-col align-self="start">
                  <small v-bind:class="{ 'text-muted': !item.synopsis }">
                      <b-icon icon="file-text" :variant="item.synopsis ? 'dark':'secondary'"></b-icon> {{!item.synopsis ? "✗" : item.synopsis}}
                  </small>
              </b-col>
          </b-row>
      </b-list-group-item>
    </script>
    <script type="text/javascript">
    Vue.component('cm-func-item', {
        props: ['item'],
        methods: {
            cc: cc,
            len: len,
        },
        template: "#cm-func-item-template"
    });
    </script>
    <script type="text/x-template" id="cm-func-item-template">
        <b-list-group-item v-bind:key="item.ID">
          <b-row class="mr-1">
              <b-col align-self="start">
                  <b-row class="ml-1">
                      <span>
                          <div v-for="doc in item.Docs" title="This is a doc" class="documentation">// {{ doc }}</div>
                      </span>
                  </b-row>
                  <b-row class="ml-1">
                    <span class="text-monospace float-left text-truncate">
                        <small>{{item.Signature}}</small> <span v-for="comment in item.Comments" class="text-comment documentation">// {{ comment }}</span>
                    </span>
                  </b-row>
              <table class="table-responsive table-sm">
                  <tbody>
                      <tr>
                          <td class="pl-0 pr-0">func <b>{{ item.Name }}</b>{{item.Parameters == null ? "( )" : "" }}</td>
                          <td class="pl-0 pr-0"
                            v-for="(param, index) in item.Parameters"
                            v-bind:param="param"
                            v-bind:index="index"
                            v-bind:key="item.ID + 'param' + index"
                            >
                            <span :title="param.KindString" data-toggle="tooltip" class="text-monospace float-left text-truncate">{{index==0 ?"(":""}}{{param.VarName ? param.VarName+" ":""}}<b>{{param.TypeString}}</b>{{index < len(item.Parameters) - 1 ? ",&nbsp;" : "" }}{{index==len(item.Parameters) - 1 ?")":""}}</span>
                          </td>
                            
                            <td class="pl-0 pr-0"
                            v-for="(param, index) in item.Results"
                            v-bind:param="param"
                            v-bind:index="index"
                            v-bind:key="item.ID + 'result' + index"
                            >
                            <span :title="param.KindString" data-toggle="tooltip" class="text-monospace float-left text-truncate">{{index==0 ?"(":""}}{{param.VarName ? param.VarName+" ":""}}<b>{{param.TypeString}}</b>{{index < len(item.Results) - 1 ? ",&nbsp;" : "" }}{{index==len(item.Results) - 1 ?")":""}}</span>
                          </td>
                      </tr>
                      <tr>
                        <td class="pl-0 pr-0">&nbsp;</td>
                        <td v-for="(param, index) in item.CodeQL.Blocks[0].Inp" class="pl-0 pr-0">
                          <b-form-checkbox class="d-flex justify-content-center" switch></b-form-checkbox>
                        </td>
                      </tr>
                  </tbody>
                  </table>
              </b-col>
          </b-row>
      </b-list-group-item>
    </script>
    <script type="text/javascript">
    Vue.component('cm-param', {
        methods: {
            cc: cc,
            len: len,
        },
        props: ['param', 'index', 'total'],
        template: "#cm-elem-param-template"
    });
    </script>
    <script type="text/x-template" id="cm-elem-param-template">
        <td :title="param.KindString" data-toggle="tooltip" class="text-monospace float-left text-truncate">{{index==0 ?"(":""}}{{param.VarName ? param.VarName+" ":""}}<b>{{param.TypeString}}</b>{{index < total - 1 ? ",&nbsp;" : "" }}{{index==total - 1 ?")":""}}</td>
    </script>
    <script type="text/javascript">
    Vue.component('cm-tm-item', {
        props: ['item'],
        template: "#cm-tm-item-template"
    });
    </script>
    <script type="text/x-template" id="cm-tm-item-template">
        <b-list-group-item v-bind:key="item.ID">
          <b-row class="mr-1">
              <b-col align-self="start">
                  <span>
                      <div v-for="doc in item.Docs" title="This is a doc" class="documentation">// {{ doc }}</div>
                  </span>
                  <span class="text-monospace float-left text-truncate">
                      <small>{{item.Func.Signature}}</small> <span v-for="comment in item.Comments" class="text-comment documentation" title="This is a comment">// {{ comment }}</span>
                  </span>
              </b-col>
          </b-row>
      </b-list-group-item>
    </script>
    <script type="text/javascript">
    Vue.component('cm-it-item', {
        props: ['item'],
        template: "#cm-it-item-template"
    });
    </script>
    <script type="text/x-template" id="cm-it-item-template">
        <b-list-group-item v-bind:key="item.ID">
          <b-row class="mr-1">
              <b-col align-self="start">
                  <span>
                      <div v-for="doc in item.Docs" title="This is a doc" class="documentation">// {{ doc }}</div>
                  </span>
                  <span class="text-monospace float-left text-truncate">
                      <small>{{item.Func.Signature}}</small> <span v-for="comment in item.Comments" class="text-comment documentation" title="This is a comment">// {{ comment }}</span>
                  </span>
              </b-col>
          </b-row>
      </b-list-group-item>
    </script>
    <script type="text/javascript">
    Vue.component('cm-struct-item', {
        methods: {
            cc: cc,
        },
        props: ['item'],
        template: "#cm-struct-item-template"
    });
    </script>
    <script type="text/x-template" id="cm-struct-item-template">
        <b-list-group-item v-bind:key="item.ID">
              <b-row class="ml-1">
                  <span>
                      <div v-for="doc in item.Docs" title="This is a doc" class="documentation">// {{ doc }}</div>
                      <div v-for="comment in item.Comments" class="documentation text-comment" title="This is a comment">// {{ comment }}</div>
                  </span>
              </b-row>
              <b-row class="ml-1">
                  <span>type <b>{{item.TypeName}}</b> struct {</span>
              </b-row>
              <table class="table-responsive table-sm table-hover">
                  <tbody>
                      <template v-for="(field, fieldIndex) in item.Fields">
                          <tr v-for="doc in field.Docs" title="This is a doc">
                              <td colspan="3" class="comment-cell">
                                  <span class="documentation pl-4">// {{ doc }}</span>
                              </td>
                          </tr>
                          <tr v-bind:class="{ 'selected-struct-field': field.Enabled }">
                              <td class="pt-0">
                                  <span class="pl-4">
                                      {{field.VarName}}
                                  </span>
                              </td>
                              <td class="pt-0">
                                  <b-form-checkbox :id="cc('checkbox',field.ID)" v-model="field.Enabled" switch></b-form-checkbox>
                              </td>
                              <td class="pt-0" :title="field.KindString">
                                  <span>
                                      {{field.TypeString}}
                                  </span>
                              </td>
                              <td class="pt-0">
                                  <span v-for="comment in field.Comments" class="text-comment documentation" title="This is a comment">// {{ comment }}</span>
                              </td>
                          </tr>
                      </template>
                  </tbody>
              </table>
              <b-row class="ml-1">
                  <span>}</span>
              </b-row>
          </b-list-group-item>
    </script>
</body>

</html>